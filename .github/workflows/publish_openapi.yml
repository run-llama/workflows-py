name: Publish OpenAPI specification

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to update (e.g. llama-index-workflows@v2.12.0)"
        required: true
      change_type:
        description: "SDK change type"
        required: true
        default: "none"
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      change_description:
        description: "Optional notes for the SDK update"
        required: false

jobs:
  publish-openapi:
    if: >
      github.repository == 'run-llama/workflows-py' &&
      (
        (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'llama-index-workflows@')) ||
        (github.event_name == 'workflow_dispatch' && startsWith(github.event.inputs.tag, 'llama-index-workflows@'))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Resolve target tag
        id: target
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "TARGET_TAG=$TAG" >> $GITHUB_ENV

      - name: Extract version information
        id: version
        run: >
          uv run --package workflows-dev workflows-dev extract-tag-info
          --tag "${{ env.TARGET_TAG }}"
          --tag-prefix "llama-index-workflows@"
          --output "$GITHUB_OUTPUT"

      - name: Sync dependencies and build OpenAPI spec
        run: |
          uv sync --all-extras
          uv run hatch run server:openapi

      - name: Upload OpenAPI to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_TAG }}
          files: openapi.json
          fail_on_unmatched_files: true
          append_body: false

      - name: Detect change type automatically
        id: detect_change
        if: github.event_name == 'release'
        env:
          GITHUB_REF: refs/tags/${{ env.TARGET_TAG }}
        run: >
          uv run --package workflows-dev workflows-dev detect-change-type
          --repo .
          --tag-glob "llama-index-workflows@v*"
          --tag-prefix "llama-index-workflows@"

      - name: Resolve change metadata
        id: metadata
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "change_type=${{ github.event.inputs.change_type }}" >> $GITHUB_OUTPUT
            echo "change_description=${{ github.event.inputs.change_description }}" >> $GITHUB_OUTPUT
          else
            echo "change_type=${{ steps.detect_change.outputs.change_type }}" >> $GITHUB_OUTPUT
            echo "change_description=" >> $GITHUB_OUTPUT
          fi

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CI_BOT_APP_ID }}
          private-key: ${{ secrets.CI_BOT_PRIVATE_KEY }}
          owner: run-llama

      - name: Trigger SDK update
        if: >
          steps.metadata.outputs.change_type != '' &&
          steps.metadata.outputs.change_type != 'none'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: run-llama/llama-ui
          event-type: workflows-sdk-update
          client-payload: >-
            {"version": "${{ steps.version.outputs.semver }}",
             "openapi_url": "https://github.com/run-llama/workflows-py/releases/download/${{ env.TARGET_TAG }}/openapi.json",
             "change_type": "${{ steps.metadata.outputs.change_type }}",
             "change_description": "${{ steps.metadata.outputs.change_description }}"}

