name: Publish packages to PyPI and GitHub

on:
  push:
    tags:
      - "llama-index-workflows@v*"
      - "llama-index-utils-workflow@v*"

jobs:
  publish:
    if: >
      github.repository == 'run-llama/workflows-py' &&
      startsWith(github.ref, 'refs/tags/') &&
      startsWith(github.ref_name, matrix.tag_prefix)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: llama-index-workflows
            display_name: LlamaIndex Workflows
            package_dir: .
            tag_prefix: "llama-index-workflows@"
            package_label: "pkg:llama-index-workflows"
            pyproject_path: "pyproject.toml"
            artifact_glob: "dist/*"
          - package: llama-index-utils-workflow
            display_name: LlamaIndex Utils Workflow
            package_dir: "packages/llama-index-utils-workflow"
            tag_prefix: "llama-index-utils-workflow@"
            package_label: "pkg:llama-index-utils-workflow"
            pyproject_path: "packages/llama-index-utils-workflow/pyproject.toml"
            artifact_glob: "dist/*"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Validate version tag
        run: >
          uv run --package workflows-dev workflows-dev validate-version
          --pyproject ${{ matrix.pyproject_path }}
          --tag-prefix ${{ matrix.tag_prefix }}
          --tag ${{ github.ref_name }}

      - name: Extract tag version
        id: version
        run: >
          uv run --package workflows-dev workflows-dev extract-tag-info
          --tag ${{ github.ref_name }}
          --tag-prefix ${{ matrix.tag_prefix }}
          --output "$GITHUB_OUTPUT"

      - name: Determine previous tag
        id: previous_tag
        run: >
          uv run --package workflows-dev workflows-dev find-previous-tag
          --repo .
          --tag-prefix ${{ matrix.tag_prefix }}
          --current-tag ${{ github.ref_name }}
          --output "$GITHUB_OUTPUT"

      - name: Generate release notes
        id: notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          uv run --package workflows-dev workflows-dev generate-release-notes
          --repository ${{ github.repository }}
          --package-label ${{ matrix.package_label }}
          --package-name "${{ matrix.display_name }}"
          --current-tag ${{ github.ref_name }}
          --previous-tag "${{ steps.previous_tag.outputs.previous }}"
          --semver ${{ steps.version.outputs.semver }}
          --output "$GITHUB_OUTPUT"

      - name: Build package
        working-directory: ${{ matrix.package_dir }}
        run: uv build

      - name: Publish to PyPI
        working-directory: ${{ matrix.package_dir }}
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: uv publish

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: "${{ matrix.display_name }} ${{ steps.version.outputs.tag_suffix }}"
          body: ${{ steps.notes.outputs.body }}
          artifacts: ${{ matrix.artifact_glob }}
